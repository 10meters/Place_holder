{% extends "base.html" %}
{% block content %}

<div class="bg-gray-900 min-h-screen px-6 py-6 lg:px-8">
  <div class="w-full h-[calc(100vh-3rem)] grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- Left Column -->
    <div class="bg-gray-800 rounded-xl shadow-lg ring-1 ring-white/10 flex flex-col overflow-hidden">

      <!-- Top Half: Nearby Competitors -->
      <div class="flex-1 p-6 overflow-y-auto border-b border-gray-700">
        <h2 class="text-2xl font-semibold text-white mb-6">Explore the Competition</h2>
        <div class="space-y-4" id="competitors-list">
          {% for district, categories in data.items() %}
            {% for category, businesses in categories.items() %}
              {% for name, details in businesses.items() %}
                <div class="flex justify-between items-center bg-gray-700 rounded-lg p-4 hover:bg-gray-600 transition cursor-pointer competitor-item" 
                     data-category="{{ category }}"
                     data-name="{{ name }}"
                     onclick="showVoronoiForCategory('{{ category }}', '{{ name }}')">
                  <div>
                    <p class="text-white font-medium">{{ name }}</p>
                    <p class="text-sm text-gray-400">{{ details.Address }}</p>
                  </div>
                  <div class="flex flex-col items-end">
                    <span class="
                      {% if category == 'Education' %}bg-yellow-500
                      {% elif category == 'Hospitals' %}bg-red-500
                      {% else %}bg-indigo-500{% endif %}
                      text-white px-3 py-1 rounded-full text-sm mb-1">
                      {{ category }}
                    </span>
                    <span class="text-xs text-gray-300">
                      Population: {{ details.Population or 'N/A' }}
                    </span>
                  </div>
                </div>
              {% endfor %}
            {% endfor %}
          {% endfor %}
        </div>
      </div>

      <!-- Bottom Half: General Information & Button -->
      <div class="flex flex-col bg-gray-700 bg-opacity-60 text-gray-400 h-1/2">
        
        <!-- General Info (3/4 height) -->
        <div class="flex-1 p-6 overflow-y-auto border-t border-gray-700" id="general-info">
          <h2 class="text-2xl font-semibold text-white">General Information</h2>
          <div id="general-info-content" class="mt-2 text-gray-400 text-lg">
            Select a location to view more details.
          </div>
        </div>

        <!-- Button Container (1/4 height) -->
        <div class="h-1/4 flex">
          <!-- Back Button -->
          <a href="{{ url_for('user_input') }}" 
             class="flex-1 bg-gray-600 hover:bg-gray-500 text-white flex items-center justify-center text-lg font-semibold transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
            </svg>
            Back
          </a>
          
          <!-- Set-up Business Button -->
          <a href="{{ url_for('suggestions', location=input['location'], industries=input['industries']) }}" 
             class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white flex items-center justify-center text-lg font-semibold transition">
            Set-up Your Business â†’
          </a>
        </div>

      </div>

    </div>

    <!-- Map -->
    <div class="lg:col-span-2 bg-gray-800 rounded-xl shadow-lg ring-1 ring-white/10 overflow-hidden">
      <div id="map" class="w-full h-full"></div>
    </div>
  </div>
</div>

<!-- Leaflet & D3 Scripts -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/d3-voronoi@1.1.4/dist/d3-voronoi.min.js"></script>

<script>
  // Initialize map with Tondo coordinates
  const map = L.map('map').setView([14.6186, 120.9700], 14);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Store all locations data
  const allLocations = {
    {% for district, categories in data.items() %}
      {% for category, businesses in categories.items() %}
        "{{ category }}": [
          {% for name, details in businesses.items() %}
            {
              name: "{{ name }}",
              category: "{{ category }}",
              lat: parseFloat("{{ details.Coordinates.Latitude }}"),
              lng: parseFloat("{{ details.Coordinates.Longitude }}"),
              address: "{{ details.Address }}",
              contact: "{{ details['Contact Number'] }}",
              population: "{{ details.Population }}",
              {% if category == 'Education' %}
              type: "{{ details['Kind of School'] }}"
              {% endif %}
            },
          {% endfor %}
        ],
      {% endfor %}
    {% endfor %}
  };

  // Current state
  let currentCategory = Object.keys(allLocations)[0] || 'Education';
  let currentHighlight = null;
  let voronoiLayer = null;
  let highlightedMarker = null;

  // Enhanced color palettes for each category
  const categoryPalettes = {
    'Education': [
      '#FFD700', '#FF4500', '#9400D3', '#00BFFF', '#00FA9A'
    ],
    'Hospitals': [
      '#FF0000', '#00FFFF', '#FF00FF', '#FFFF00', '#FFA500'
    ],
    'Markets': [
      '#0000FF', '#FF8C00', '#4B0082', '#7CFC00', '#FF1493'
    ],
    'Default': [
      '#00FF00', '#FF007F', '#000080', '#FFD700', '#8A2BE2'
    ]
  };

  // Stable color generator using business names as seeds
  function stringToColor(str, category) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    const palette = categoryPalettes[category] || categoryPalettes['Default'];
    const index = Math.abs(hash) % palette.length;
    return palette[index];
  }

  function createVoronoiDiagram(points) {
    const mappedPoints = points.map(h => {
      const pt = map.latLngToContainerPoint([h.lat, h.lng]);
      return [pt.x, pt.y, h];
    });

    const voronoi = d3.voronoi()
      .extent([[-1, -1], [map.getSize().x + 1, map.getSize().y + 1]])
      (mappedPoints.map(d => [d[0], d[1]]));

    return voronoi.polygons().map((polygon, i) => {
      if (!polygon) return null;
      const latLngs = polygon.map(p => map.containerPointToLatLng([p[0], p[1]]));
      return { polygon: latLngs, location: mappedPoints[i][2] };
    }).filter(Boolean);
  }

  function highlightListItem(name) {
    document.querySelectorAll('.competitor-item').forEach(item => {
      if (item.dataset.name === name) {
        item.classList.add('bg-gray-600');
        item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else {
        item.classList.remove('bg-gray-600');
      }
    });
  }

  function drawVoronoiCells() {
    // Clear existing layers
    if (voronoiLayer) map.removeLayer(voronoiLayer);
    
    // Get locations for the current category
    const locations = allLocations[currentCategory] || [];
    const polygons = createVoronoiDiagram(locations);
    voronoiLayer = L.layerGroup().addTo(map);

    // Draw Voronoi cells
    polygons.forEach((cell) => {
      const isHighlighted = currentHighlight && cell.location.name === currentHighlight;
      const color = stringToColor(cell.location.name, currentCategory);
      
      const polygon = L.polygon(cell.polygon, {
        fillColor: color,
        fillOpacity: isHighlighted ? 0.6 : 0.4,
        weight: isHighlighted ? 3 : 2,
        opacity: 1,
        color: isHighlighted ? '#ffffff' : '#333333',
        dashArray: isHighlighted ? null : '5,5'
      }).bindPopup(`
        <div class="text-gray-800">
          <b class="text-lg">${cell.location.name}</b>
          <p class="mt-1">${cell.location.address}</p>
          <p class="mt-1"><b>Contact:</b> ${cell.location.contact}</p>
          <p class="mt-1"><b>Population:</b> ${cell.location.population || 'N/A'}</p>
          ${cell.location.type ? `<p><b>Type:</b> ${cell.location.type}</p>` : ''}
        </div>
      `, {
        autoClose: false,
        closeOnClick: false,
        autoPan: false
      });

      polygon.on('click', () => {
        showVoronoiForCategory(currentCategory, cell.location.name);
        highlightListItem(cell.location.name);
      });

      polygon.addTo(voronoiLayer);
    });

    // Draw markers
    locations.forEach((location) => {
      const isHighlighted = currentHighlight && location.name === currentHighlight;
      const color = stringToColor(location.name, currentCategory);
      
      const marker = L.circleMarker([location.lat, location.lng], {
        radius: isHighlighted ? 10 : 7,
        fillColor: color,
        color: isHighlighted ? '#ffffff' : '#333333',
        weight: isHighlighted ? 3 : 2,
        opacity: 1,
        fillOpacity: 0.9
      }).bindPopup(`
        <div class="text-gray-800">
          <b class="text-lg">${location.name}</b>
          <p class="mt-1">${location.address}</p>
          <p class="mt-1"><b>Contact:</b> ${location.contact}</p>
          <p class="mt-1"><b>Population:</b> ${location.population || 'N/A'}</p>
          ${location.type ? `<p><b>Type:</b> ${location.type}</p>` : ''}
        </div>
      `, {
        autoClose: false,
        closeOnClick: false,
        autoPan: false
      }).addTo(voronoiLayer);

      if (isHighlighted) {
        highlightedMarker = marker;
        marker.openPopup();
      }
    });
  }

  function showVoronoiForCategory(category, name) {
    currentCategory = category;
    currentHighlight = name;
    drawVoronoiCells();
    highlightListItem(name);
    
    // Update the general info panel
    const location = allLocations[category].find(loc => loc.name === name);
    const infoContent = document.getElementById("general-info-content");
    
    let html = `
      <div class="space-y-2">
        <h4 class="text-xl font-bold text-white">${name}</h4>
        <p><span class="font-medium text-gray-300">Category:</span> ${category}</p>
        <p><span class="font-medium text-gray-300">Address:</span> ${location.address}</p>
        <p><span class="font-medium text-gray-300">Contact:</span> ${location.contact}</p>
        <p><span class="font-medium text-gray-300">Population:</span> ${location.population || 'N/A'}</p>
    `;
    
    if (category === 'Education') {
      html += `<p><span class="font-medium text-gray-300">Type:</span> ${location.type}</p>`;
    }
    
    html += `</div>`;
    
    infoContent.innerHTML = html;
    infoContent.classList.remove("text-gray-400");
    infoContent.classList.add("text-white");
  }

  // Re-render on zoom/move
  function handleMapChange() {
    if (currentCategory) {
      drawVoronoiCells();
    }
  }

  map.on('moveend', handleMapChange);
  map.on('zoomend', handleMapChange);

  // Initial render
  if (Object.keys(allLocations).length > 0) {
    const firstCategory = Object.keys(allLocations)[0];
    if (allLocations[firstCategory] && allLocations[firstCategory].length > 0) {
      showVoronoiForCategory(firstCategory, allLocations[firstCategory][0].name);
    }
  }
</script>

{% endblock %}