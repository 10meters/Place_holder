{% extends "base.html" %}
{% block content %}

<div class="bg-gray-900 min-h-screen px-6 py-12 lg:px-8">
  <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <!-- Competitors List (1/3) -->
    <div class="bg-gray-800 rounded-xl shadow-lg ring-1 ring-white/10 p-6 flex flex-col">
      <h2 class="text-2xl font-semibold text-white mb-6">Nearby Competitors</h2>
      <div class="space-y-4 overflow-y-auto">
        <!-- Competitor Example Item -->
        <div class="flex justify-between items-center bg-gray-700 rounded-lg p-4 hover:bg-gray-600 transition">
          <div>
            <p class="text-white font-medium">ABC Food Hub</p>
            <p class="text-sm text-gray-400">1.2 km — Makati</p>
          </div>
          <span class="bg-indigo-500 text-white px-3 py-1 rounded-full text-sm">Food</span>
        </div>

        <div class="flex justify-between items-center bg-gray-700 rounded-lg p-4 hover:bg-gray-600 transition">
          <div>
            <p class="text-white font-medium">Clean&Go Laundry</p>
            <p class="text-sm text-gray-400">850 m — Makati</p>
          </div>
          <span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm">Laundry</span>
        </div>

        <div class="flex justify-between items-center bg-gray-700 rounded-lg p-4 hover:bg-gray-600 transition">
          <div>
            <p class="text-white font-medium">LearnSmart Academy</p>
            <p class="text-sm text-gray-400">2.1 km — Makati</p>
          </div>
          <span class="bg-yellow-500 text-white px-3 py-1 rounded-full text-sm">Education</span>
        </div>
      </div>
    </div>

    <!-- Map (2/3) -->
    <div class="lg:col-span-2 bg-gray-800 rounded-xl shadow-lg ring-1 ring-white/10 overflow-hidden">
      <div id="map" class="w-full h-[80vh]"></div>
    </div>
  </div>
</div>

<!-- Leaflet & D3 Scripts -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/d3-voronoi@1.1.4/dist/d3-voronoi.min.js"></script>

<script>
  const map = L.map('map').setView([14.5995, 120.9842], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const hospitals = [
    {name: "Philippine General Hospital", lat: 14.5826, lng: 120.9889},
    {name: "St. Luke's Medical Center", lat: 14.5638, lng: 121.0294},
    {name: "Manila Doctors Hospital", lat: 14.5762, lng: 120.9869},
    {name: "Chinese General Hospital", lat: 14.6184, lng: 120.9958}
  ];

  function getColor(index) {
    const colors = [
      'rgba(255, 99, 132, 0.5)',
      'rgba(54, 162, 235, 0.5)',
      'rgba(255, 206, 86, 0.5)',
      'rgba(75, 192, 192, 0.5)'
    ];
    return colors[index % colors.length];
  }

  function createVoronoiDiagram() {
    const points = hospitals.map(h => {
      const pt = map.latLngToContainerPoint([h.lat, h.lng]);
      return [pt.x, pt.y, h];
    });

    const voronoi = d3.voronoi()
      .extent([[-1, -1], [map.getSize().x + 1, map.getSize().y + 1]])
      (points.map(d => [d[0], d[1]]));

    return voronoi.polygons().map((polygon, i) => {
      if (!polygon) return null;
      const latLngs = polygon.map(p => map.containerPointToLatLng([p[0], p[1]]));
      return { polygon: latLngs, hospital: points[i][2] };
    }).filter(Boolean);
  }

  function drawVoronoiCells() {
    if (window.voronoiLayer) map.removeLayer(window.voronoiLayer);
    const polygons = createVoronoiDiagram();
    const voronoiLayer = L.layerGroup().addTo(map);
    window.voronoiLayer = voronoiLayer;

    polygons.forEach((cell, i) => {
      const color = getColor(i);
      L.polygon(cell.polygon, {
        fillColor: color,
        fillOpacity: 0.5,
        weight: 1,
        opacity: 0.8,
        color: '#333'
      }).bindPopup(`<b>${cell.hospital.name}</b>`).addTo(voronoiLayer);
    });

    hospitals.forEach((h, i) => {
      const color = getColor(i).replace('0.5', '1');
      L.circleMarker([h.lat, h.lng], {
        radius: 6,
        fillColor: color,
        color: '#333',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      }).bindPopup(`<b>${h.name}</b>`).addTo(voronoiLayer);
    });
  }

  map.on('moveend', drawVoronoiCells);
  map.on('zoomend', drawVoronoiCells);
  drawVoronoiCells();
</script>

{% endblock %}

