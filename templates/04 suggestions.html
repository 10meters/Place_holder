{% extends "base.html" %}
{% block content %}

<div class="bg-gray-900 min-h-screen px-6 py-6 lg:px-8">

  <div class="w-full h-[calc(100vh-3rem)] grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- Left Column -->
    <div class="bg-gray-800 rounded-xl shadow-lg ring-1 ring-white/10 flex flex-col overflow-hidden">

      <!-- Potential Locations List -->
      <div class="flex-1 p-6 overflow-y-auto border-b border-gray-700">
        <h2 class="text-2xl font-semibold text-white mb-6">Potential Locations for You</h2>
        <div class="space-y-4">

          <!-- Sort properties by highlight priority: cost_effective → cheapest → biggest → others -->
          {% set sorted_properties = suggestions.properties|sort(attribute='name') %}
          {% set cost_effective = sorted_properties|selectattr('name', 'equalto', suggestions.highlights.most_cost_effective) %}
          {% set cheapest = sorted_properties|selectattr('name', 'equalto', suggestions.highlights.cheapest)|rejectattr('name', 'equalto', suggestions.highlights.most_cost_effective) %}
          {% set biggest = sorted_properties|selectattr('name', 'equalto', suggestions.highlights.biggest)|rejectattr('name', 'equalto', suggestions.highlights.most_cost_effective)|rejectattr('name', 'equalto', suggestions.highlights.cheapest) %}
          {% set others = sorted_properties|rejectattr('name', 'equalto', suggestions.highlights.most_cost_effective)|rejectattr('name', 'equalto', suggestions.highlights.cheapest)|rejectattr('name', 'equalto', suggestions.highlights.biggest) %}

          <!-- Cost Effective Locations First -->
          {% for property in cost_effective %}
          <div class="flex justify-between items-center bg-gray-700 rounded-lg p-4 hover:bg-gray-600 transition cursor-pointer location-item"
               data-name="{{ property.name }}"
               data-info="Area: {{ property.area_in_sqm }} | Price: {{ property.price }}"
               data-lat="{{ property.coordinates.lat }}"
               data-lng="{{ property.coordinates.lng }}"
               data-highlight="cost_effective">
            <div>
              <p class="text-white font-medium">{{ property.name }}</p>
              <p class="text-sm text-gray-400">{{ input.location }}</p>
            </div>
            <span class="bg-yellow-500 text-white px-3 py-1 rounded-full text-sm">Most Cost-Effective</span>
          </div>
          {% endfor %}

          <!-- Cheapest Locations Next -->
          {% for property in cheapest %}
          <div class="flex justify-between items-center bg-gray-700 rounded-lg p-4 hover:bg-gray-600 transition cursor-pointer location-item"
               data-name="{{ property.name }}"
               data-info="Area: {{ property.area_in_sqm }} | Price: {{ property.price }}"
               data-lat="{{ property.coordinates.lat }}"
               data-lng="{{ property.coordinates.lng }}"
               data-highlight="cheapest">
            <div>
              <p class="text-white font-medium">{{ property.name }}</p>
              <p class="text-sm text-gray-400">{{ input.location }}</p>
            </div>
            <span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm">Cheapest</span>
          </div>
          {% endfor %}

          <!-- Biggest Locations Next -->
          {% for property in biggest %}
          <div class="flex justify-between items-center bg-gray-700 rounded-lg p-4 hover:bg-gray-600 transition cursor-pointer location-item"
               data-name="{{ property.name }}"
               data-info="Area: {{ property.area_in_sqm }} | Price: {{ property.price }}"
               data-lat="{{ property.coordinates.lat }}"
               data-lng="{{ property.coordinates.lng }}"
               data-highlight="biggest">
            <div>
              <p class="text-white font-medium">{{ property.name }}</p>
              <p class="text-sm text-gray-400">{{ input.location }}</p>
            </div>
            <span class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm">Biggest</span>
          </div>
          {% endfor %}

          <!-- Other Locations Last -->
          {% for property in others %}
          <div class="flex justify-between items-center bg-gray-700 rounded-lg p-4 hover:bg-gray-600 transition cursor-pointer location-item"
               data-name="{{ property.name }}"
               data-info="Area: {{ property.area_in_sqm }} | Price: {{ property.price }}"
               data-lat="{{ property.coordinates.lat }}"
               data-lng="{{ property.coordinates.lng }}"
               data-highlight="">
            <div>
              <p class="text-white font-medium">{{ property.name }}</p>
              <p class="text-sm text-gray-400">{{ input.location }}</p>
            </div>
          </div>
          {% endfor %}

        </div>
      </div>

      <!-- Bottom Half: General Information & Button -->
      <div class="flex flex-col bg-gray-700 bg-opacity-60 text-gray-400 h-1/2">

        <!-- General Info (3/4 height) -->
        <div class="flex-1 p-6 overflow-y-auto border-t border-gray-700" id="general-info">
          <h2 class="text-2xl font-semibold text-white">General Information</h2>
          <div id="general-info-content" class="mt-2 text-gray-400 text-lg">
            Select a location to view more details.
          </div>
        </div>

        <!-- Return Button (1/4 height) -->
        <a href="{{ url_for('map', location=input.location, industries=input.industries) }}" 
           class="h-1/4 bg-indigo-600 hover:bg-indigo-500 text-white flex items-center justify-center text-lg font-semibold transition">
          ← Return to Competitors
        </a>

      </div>
    </div>

    <!-- Map -->
    <div class="lg:col-span-2 bg-gray-800 rounded-xl shadow-lg ring-1 ring-white/10 overflow-hidden">
      <div id="map" class="w-full h-full"></div>
    </div>

  </div>
</div>

<!-- Leaflet & D3 Scripts -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/d3-voronoi@1.1.4/dist/d3-voronoi.min.js"></script>

<script>
  // Initialize map with first property's coordinates or default
  {% if suggestions.properties and suggestions.properties|length > 0 %}
    // Get first property from our sorted list (cost_effective first)
    {% set first_property = (suggestions.properties|selectattr('name', 'equalto', suggestions.highlights.most_cost_effective)|first) or 
                            (suggestions.properties|selectattr('name', 'equalto', suggestions.highlights.cheapest)|first) or 
                            (suggestions.properties|selectattr('name', 'equalto', suggestions.highlights.biggest)|first) or 
                            suggestions.properties|first %}
    const firstProperty = {{ first_property.coordinates|tojson }};
    const map = L.map('map').setView([firstProperty.lat, firstProperty.lng], 13);
  {% else %}
    const map = L.map('map').setView([14.5995, 120.9842], 13);
  {% endif %}

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Process properties data in highlight priority order
  const properties = [
    // Cost effective first
    {% for property in suggestions.properties if property.name == suggestions.highlights.most_cost_effective %}
    {
      name: "{{ property.name }}",
      lat: {{ property.coordinates.lat }},
      lng: {{ property.coordinates.lng }},
      area: "{{ property.area_in_sqm }}",
      price: "{{ property.price }}",
      highlight: "cost_effective"
    },
    {% endfor %}
    
    // Cheapest next
    {% for property in suggestions.properties if property.name == suggestions.highlights.cheapest and property.name != suggestions.highlights.most_cost_effective %}
    {
      name: "{{ property.name }}",
      lat: {{ property.coordinates.lat }},
      lng: {{ property.coordinates.lng }},
      area: "{{ property.area_in_sqm }}",
      price: "{{ property.price }}",
      highlight: "cheapest"
    },
    {% endfor %}
    
    // Biggest next
    {% for property in suggestions.properties if property.name == suggestions.highlights.biggest and property.name != suggestions.highlights.most_cost_effective and property.name != suggestions.highlights.cheapest %}
    {
      name: "{{ property.name }}",
      lat: {{ property.coordinates.lat }},
      lng: {{ property.coordinates.lng }},
      area: "{{ property.area_in_sqm }}",
      price: "{{ property.price }}",
      highlight: "biggest"
    },
    {% endfor %}
    
    // Others last
    {% for property in suggestions.properties if property.name != suggestions.highlights.most_cost_effective and property.name != suggestions.highlights.cheapest and property.name != suggestions.highlights.biggest %}
    {
      name: "{{ property.name }}",
      lat: {{ property.coordinates.lat }},
      lng: {{ property.coordinates.lng }},
      area: "{{ property.area_in_sqm }}",
      price: "{{ property.price }}",
      highlight: ""
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  // Process voronoi_data for competitors
  const competitors = [
    {% for district, industries in data.items() %}
      {% for industry, businesses in industries.items() %}
        {% if industry == input.industries|replace("['", "")|replace("']", "") %}
          {% for business, details in businesses.items() %}
            {
              name: "{{ business }}",
              lat: parseFloat("{{ details.Coordinates.Latitude }}"),
              lng: parseFloat("{{ details.Coordinates.Longitude }}"),
              population: parseInt("{{ details.Population }}"),
              address: "{{ details.Address }}"
            },
          {% endfor %}
        {% endif %}
      {% endfor %}
    {% endfor %}
  ];

  // Custom icons
  const markerIcons = {
    default: L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41]
    }),
    cheapest: L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41]
    }),
    biggest: L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41]
    }),
    cost_effective: L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41]
    }),
    selected: L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png',
      iconSize: [35, 51],
      iconAnchor: [17, 51]
    })
  };

  // Layer groups
  const voronoiLayer = L.layerGroup().addTo(map);
  const propertyLayer = L.layerGroup().addTo(map);
  const competitorLayer = L.layerGroup().addTo(map);
  let selectedMarker = null;

  function createVoronoiDiagram() {
    const points = competitors.map(c => {
      const pt = map.latLngToContainerPoint([c.lat, c.lng]);
      return [pt.x, pt.y, c];
    });

    const voronoi = d3.voronoi()
      .extent([[-1, -1], [map.getSize().x + 1, map.getSize().y + 1]])
      (points.map(d => [d[0], d[1]]));

    return voronoi.polygons().map((polygon, i) => {
      if (!polygon) return null;
      const latLngs = polygon.map(p => map.containerPointToLatLng([p[0], p[1]]));
      return { polygon: latLngs, competitor: points[i][2] };
    }).filter(Boolean);
  }

  function drawVoronoi() {
    voronoiLayer.clearLayers();
    const polygons = createVoronoiDiagram();
    
    polygons.forEach((cell, i) => {
      const color = `hsl(${(i * 60) % 360}, 70%, 50%)`;
      L.polygon(cell.polygon, {
        fillColor: color,
        fillOpacity: 0.2,
        weight: 1,
        opacity: 0.7,
        color: '#333',
        dashArray: '5,5'
      }).bindPopup(`<b>${cell.competitor.name}</b>`).addTo(voronoiLayer);
    });
  }

  function drawProperties() {
    propertyLayer.clearLayers();
    
    properties.forEach(property => {
      const iconType = property.highlight || 'default';
      L.marker([property.lat, property.lng], {
        icon: markerIcons[iconType],
        zIndexOffset: iconType === 'default' ? 0 : 10
      }).bindPopup(`
        <div class="text-gray-800">
          <b>${property.name}</b>
          <p>Area: ${property.area}</p>
          <p>Price: ${property.price}</p>
          ${property.highlight ? `<p class="font-semibold ${property.highlight === 'cheapest' ? 'text-green-500' : property.highlight === 'biggest' ? 'text-blue-500' : 'text-yellow-500'}">${property.highlight.replace('_', ' ').toUpperCase()}</p>` : ''}
        </div>
      `).addTo(propertyLayer);
    });
  }

  function drawCompetitors() {
    competitorLayer.clearLayers();
    
    competitors.forEach(competitor => {
      L.circleMarker([competitor.lat, competitor.lng], {
        radius: 6,
        fillColor: '#EF4444',
        color: '#fff',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      }).bindPopup(`
        <div class="text-gray-800">
          <b>${competitor.name}</b>
          <p>${competitor.address}</p>
          <p>Population: ${competitor.population.toLocaleString()}</p>
        </div>
      `).addTo(competitorLayer);
    });
  }

  function selectProperty(name) {
    const property = properties.find(p => p.name === name);
    if (!property) return;
    
    if (selectedMarker) {
      propertyLayer.removeLayer(selectedMarker);
    }
    
    selectedMarker = L.marker([property.lat, property.lng], {
      icon: markerIcons.selected,
      zIndexOffset: 100
    }).bindPopup(`
      <div class="text-gray-800">
        <b>${property.name}</b>
        <p>Area: ${property.area}</p>
        <p>Price: ${property.price}</p>
        ${property.highlight ? `<p class="font-semibold ${property.highlight === 'cheapest' ? 'text-green-500' : property.highlight === 'biggest' ? 'text-blue-500' : 'text-yellow-500'}">${property.highlight.replace('_', ' ').toUpperCase()}</p>` : ''}
      </div>
    `).addTo(propertyLayer);
    
    map.setView([property.lat, property.lng], 15);
    selectedMarker.openPopup();
  }

  // Initial draw
  drawVoronoi();
  drawProperties();
  drawCompetitors();

  // Select first property by default (following our priority order)
  {% if suggestions.properties and suggestions.properties|length > 0 %}
    {% set first_property = (suggestions.properties|selectattr('name', 'equalto', suggestions.highlights.most_cost_effective)|first) or 
                            (suggestions.properties|selectattr('name', 'equalto', suggestions.highlights.cheapest)|first) or 
                            (suggestions.properties|selectattr('name', 'equalto', suggestions.highlights.biggest)|first) or 
                            suggestions.properties|first %}
    selectProperty("{{ first_property.name }}");
  {% endif %}

  // Update selection on click
  document.querySelectorAll('.location-item').forEach(item => {
    item.addEventListener('click', () => {
      const name = item.dataset.name;
      const info = item.dataset.info;
      const highlight = item.dataset.highlight;
      
      document.getElementById('general-info-content').innerHTML = `
        <div>
          <h3 class="text-xl font-semibold text-white">${name}</h3>
          <p class="text-gray-300">${info}</p>
          ${highlight ? `<p class="mt-2 ${highlight === 'cheapest' ? 'text-green-400' : highlight === 'biggest' ? 'text-blue-400' : 'text-yellow-400'} font-medium">${highlight.replace('_', ' ').toUpperCase()}</p>` : ''}
        </div>
      `;
      
      selectProperty(name);
    });
  });

  // Redraw Voronoi on map events
  map.on('moveend', drawVoronoi);
  map.on('zoomend', drawVoronoi);
</script>

{% endblock %}